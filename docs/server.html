<!DOCTYPE html>
<html>
<body>

    <h2>The XMLHttpRequest Object</h2>

    <button type="button" onclick="createAccount()" disabled="true">Create account</button>
    <button type="button" onclick="logIn()">Log in</button>
    <button type="button" onclick="signOut()">Sign out</button>
    <button type="button" onclick="addScore()">Add score</button>
    <button type="button" onclick="getTopScores()">Get top scores</button>
    <button type="button" onclick="getUserScores()">Get user's scores</button>

    <p id="message"></p>


    <script>
    var session;
    var username = 'HappyUser';

    function createAccount() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("message").innerHTML = "account created";
            }
        };
        request.open("POST", "http://193.10.30.163/users", true);
        request.setRequestHeader("Content-Type", "application/json");
        request.addEventListener("load", function(){
            console.log("We got response from server!");
            console.log("Status code: ", request.status);
            console.log("Body: ", request.responseText);
        });
        request.send('{"email": "happyuser@members.com", "username": "HappyUser", "password": "happyuserpw", "firstName": "Happy", "lastName": "User"}');
    }

    function logIn() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("message").innerHTML = this.responseText;
                var info = JSON.parse(this.responseText);
                username = info.username;
                session = info.session;
            }
        };
        request.open("POST", "http://193.10.30.163/users/login", true);
        request.setRequestHeader("Content-Type", "application/json");
        request.addEventListener("load", function(){
            console.log("We got response from server!");
            console.log("Status code: ", request.status);
            console.log("Body: ", request.responseText);
        });
        request.send('{"email": "happyuser@members.com", "password": "happyuserpw"}');
    }

    function signOut() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("message").innerHTML = "Signed out";
            }
        };
        request.open("POST", "http://193.10.30.163/users/logout", true);
        request.setRequestHeader("Content-Type", "application/xml");
        request.addEventListener("load", function(){
            console.log("We got response from server!");
            console.log("Status code: ", request.status);
            console.log("Body: ", request.responseText);
        });
        request.send('<?xml version="1.0"?> <data> <session>' + session + '</session> </data>');
    }

    function addScore() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("message").innerHTML = "Score added";
            }
        };
        request.open("POST", "http://193.10.30.163/scores/" + username, true);
        request.setRequestHeader("Content-Type", "application/xml");
        request.addEventListener("load", function(){
            console.log("We got response from server!");
            console.log("Status code: ", request.status);
            console.log("Body: ", request.responseText);
        });
        request.send('<?xml version="1.0"?> <data> <session>' + session + '</session> <score>10</score> </data>');
    }

    function getTopScores() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("message").innerHTML = this.responseText;
            }
        };
        request.open("GET", "http://193.10.30.163/scores?callback=topScores&session=" + session, true);
        request.setRequestHeader("Content-Type", "application/xml");
        request.addEventListener("load", function(){
            console.log("We got response from server!");
            console.log("Status code: ", request.status);
            console.log("Body: ", request.responseText);
        });
        request.send();
    }

    var scores;
    function userScores(info) {
        var scores = info.data.scores;
        console.log("scores", scores);
        var message = document.getElementById("message");
        message.innerHTML = "";
        for (var i = 0; i < scores.length; i++) {
            var p = document.createElement("p");
            var date = new Date(Number(scores[i].addedAt) * 1000);
            var showDate = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes();
            p.innerHTML = "Score: " + scores[i].score + " added at: " + showDate;
            message.appendChild(p);
        }
    }

    function getUserScores() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                eval(this.responseText);
                /*
                var s = document.createElement("script");
                s.innerHTML = this.responseText;
                document.body.appendChild(s);
                */
            }
        };
        request.open("GET", "http://193.10.30.163/scores/" + username + "?callback=userScores&session=" + session, true);
        request.addEventListener("load", function(){
            console.log("We got response from server!");
            console.log("Status code: ", request.status);
            console.log("Body: ", request.responseText);
        });
        request.send();
    }
    </script>

</body>
</html>
